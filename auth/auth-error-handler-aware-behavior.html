<script>
    window.PolymerApigility = window.PolymerApigility || {};

    PolymerApigility.AuthErrorHandlerAwareBehaviorImp = {

        properties: {

            auth: {
                type: Object,
                value: null
            },

            reSendLastRequest: {
                type: Boolean,
                readOnly: true,
                value: false
            },

            lastRequestParams: {
                type: Boolean,
                readOnly: true,
                value: false
            }
        },

        ready: function () {
            this.$.ironAjax.addEventListener('error', this.responseAuthErrorHandlerAware.bind(this));
            this.addEventListener('api-request-presend', this.saveLastRequest.bind(this));
            document.addEventListener('refresh-auth-complete', this.resendLastRequestResponse.bind(this));
        },

        saveLastRequest: function(event) {
            var lastRequestParams = {};
            lastRequestParams['method'] = event.detail.method;
            lastRequestParams['headers'] = event.detail.headers;
            lastRequestParams['body'] = event.detail.body;
            lastRequestParams['params']=  event.detail.params;
            this._setLastRequestParams(lastRequestParams);

            if (this.auth) {
                if (this.$.ironAjax.headers !== null && typeof this.$.ironAjax.headers === 'object') {
                    this.$.ironAjax.headers['Authorization'] =  'Bearer ' + this.auth.access_token;
                } else {
                    this.$.ironAjax = {'Authorization': 'Bearer ' + this.auth.access_token};

                }
            }
        },

        responseAuthErrorHandlerAware: function (event) {
            if (event.detail.request.status === 401 && this.auth) {
                this._setReSendLastRequest(true);
                var message = {detail: {element: this}, bubbles: true, cancelable: true}
                var event = new CustomEvent("refresh-auth", message);
                document.dispatchEvent(event);
            }
        },

        resendLastRequestResponse: function (event) {
            if (this.reSendLastRequest && this.lastRequestParams) {
                this.createRequest(
                        this.lastRequestParams['method'],
                        this.lastRequestParams['body'],
                        this.lastRequestParams['headers'],
                        this.lastRequestParams['params']
                );
            }
        }
    };
</script>