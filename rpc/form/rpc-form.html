<link rel="import" href="../rpc.html">
<link rel="import" href="../../form/form-behavior.html">

<dom-module id="apigility-rpc-form">
    <template>
        <apigility-rpc
                id="rpcClient"
                method="{{method}}"
                app-id="{{appId}}"
                root-url="{{rootUrl}}"
                service-name="{{serviceName}}"
                identify="{{identify}}"
                content-type="{{contentType}}">
        </apigility-rpc>
        <content></content>
    </template>
    <script>
        'use strict';

        Polymer({
            is: 'apigility-rpc-form',
            extends: 'form',

            properties: {

                /**
                 * By default, the form will display the browser's native validation
                 * UI (i.e. popup bubbles and invalid styles on invalid fields). You can
                 * manually disable this; however, if you do, note that you will have to
                 * manually style invalid *native* HTML fields yourself, as you are
                 * explicitly preventing the native form from doing so.
                 */
                disableNativeValidationUi: {
                    type: Boolean,
                    value: false
                },

                appId: {
                    type: String
                },

                rootUrl: {
                    type: String
                },

                serviceName: {
                    type: String
                },

                identify: {
                    type: String
                },

                genericError: {
                    type: String,
                    readOnly: true,
                    notify: true
                },

                method : {
                    type: String,
                    value: 'POST'
                }
            },

            behaviors: [
                Strapieno.UtilsBehaviorImpl,
                Strapieno.FormBehaviorImpl
            ],

            ready: function() {
                this.client = this.$.rpcClient;
            },

            /**
             */
            listeners: {
                'submit': '_onSubmit',
                'rpc-iron-ajax-error-response': '_errorResponseListener'
            },

            _onSubmit: function (event) {
                this.submit();

                // Don't perform a page refresh.
                if (event) {
                    event.preventDefault();
                }

                return false;
            },

            /**
             * Populate error message of the forms element
             */
            _errorResponseListener: function (event) {

                var bodyResponse = event.detail.ironRequest.xhr.response;
                switch (event.detail.ironRequest.status) {
                    case 422:
                        if (bodyResponse.validation_messages) {
                            this.setErrorMessages(bodyResponse.validation_messages);
                        } else {
                            // TODO is correct?
                            this._setGenericError(event.detail.ironRequest.xhr.response.title);
                        }
                        break;
                    default :
                        // TODO is correct?
                        this._setGenericError(event.detail.ironRequest.xhr.response.title);
                }
            },


            /**
             * Called to submit the form.
             */
            submit: function () {

                var restoreMultiPartFormDataContentType = false;
                if (!this.noValidate && !this.validate()) {
                    // In order to trigger the native browser invalid-form UI, we need to do perform a fake form submit.
                    if (!this.disableNativeValidationUi) {
                        this._doFakeSubmitForValidation();
                    }
                    this.fire('apigility-rpc-form-invalid');
                    return;
                }

                var data;
                switch (this.contentType) {
                    case 'multipart/form-data':
                        data = this.getFormData();
                        this.contentType = null;
                        restoreMultiPartFormDataContentType = true;
                        break;
                    default:
                        data = this.serialize();
                }
                this.client.createRequest(this.method, data);
                this.fire('apigility-rpc-form-valid');
            }
        });
    </script>
</dom-module>
